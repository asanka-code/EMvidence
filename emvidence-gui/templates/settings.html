<html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
      <link rel="stylesheet" href="/resources/demos/style.css">
      <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

      <style>
        .ui-menu {
          width: 200px;
          vertical-align: top;
        }
        #modules-button {
          width: 60;
        }
        td {
          align-self: auto;
        }
        #footer {
          position: fixed;
          bottom: 0; 
          width: 100%;
        }
      </style>

      <script>

        $( function() {
          $( "#em-data-format" ).selectmenu(
            {
              width: 200
            }
          );
        } );

        $( function() {
          $( "#select-module-to-delete" ).selectmenu(
            {
              width: 400
            }
          );
        } );

        $( function() {
          $( "#select-iot-device-to-delete" ).selectmenu(
            {
              width: 400
            }
          );
        } );        

        $( function() {
          $( ".save-button button" ).button();
          $( ".save-button button" ).click( function( event ) {
            event.preventDefault();
            // submit the data to the backend
            saveSettings();
          } );
        } );

        $( function() {
          $( ".cancel-button button" ).button();
          $( ".cancel-button button" ).click( function( event ) {
            event.preventDefault();
            window.location.href = "/settings";
          } );
        } );

        $( function() {
          $( ".widget input[type=submit]" ).button();
          $( ".widget input[type=file]" ).button();
          $( ".widget input[type=button]" ).button();
          $( "#cancel-upload" ).click( function( event ) {
            event.preventDefault();
            window.location.href = "/settings";
          } );
        } );

        $( function() {          
          $( ".module-delete-widget input[type=button]" ).button();
          $( "#delete-module" ).click( function( event ) {
            event.preventDefault();
            // send the module deletion AJAX request
          } );

          $( "#cancel-delete" ).click( function( event ) {
            event.preventDefault();
            window.location.href = "/settings";            
          } );
        } );

        $(document).ready( function() {
          // fill the default directory field
          fillDefaultDirectory();
          // set the EM data format
          setEMdataFormat();
        } );
                
        function fillDefaultDirectory() {
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              $("#default-capture-directory").val(this.responseText);              
            }
          };
          // send the AJAX request
          xhttp.open("POST", "/get_default_directory", true);
          xhttp.send();
        }
  
        function setEMdataFormat() {
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {              
              $("#em-data-format").val(this.responseText);
              $( "#em-data-format" ).selectmenu("refresh", true);
            }
          };
          // send the AJAX request
          xhttp.open("POST", "/get_em_data_format", true);
          xhttp.send();
        }
        
        function saveSettings() {            
          // a form data object
          var formData = new FormData();

          // take the default capture directory
          var capture_directory = document.getElementById("default-capture-directory").value;          
          // append the default capture directory to form data object
          formData.append("capture_directory", capture_directory);

          // take the selected em data format index
          var em_data_format = document.getElementById("em-data-format");
          em_data_format = em_data_format.options[em_data_format.selectedIndex].value;
          // append sampling rate choice to the form data object
          formData.append("em_data_format", em_data_format);

          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              if (this.responseText == "done") {                          
                // set the figures visible
                //document.getElementById("visualize-data").style.visibility = "visible";
                alert("Settings saved");
              } else {
                alert("Error occured while saving");
              }
            }
          };

          // send the AJAX request
          xhttp.open("POST", "/save_settings", true);
          xhttp.send(formData);
        }  

        $( function() {
          $( ".save-iot-button button" ).button();
          $( ".save-iot-button button" ).click( function( event ) {
            event.preventDefault();
            // submit the data to the backend
            saveIoTDevice();
          } );
        } );

        $( function() {
          $( ".cancel-iot-button button" ).button();
          $( ".cancel-iot-button button" ).click( function( event ) {
            event.preventDefault();
            window.location.href = "/settings";
          } );
        } );

        function saveIoTDevice() {            
          // a form data object
          var formData = new FormData();

          // take the new IoT devife name
          var new_iot_device_name = document.getElementById("new-iot-device-name").value;          
          // append the new IoT device name to form data object
          formData.append("new_iot_device_name", new_iot_device_name);

          // take the new IoT devife description
          var new_iot_device_description = document.getElementById("new-iot-device-description").value;
          // append the new IoT device description to form data object
          formData.append("new_iot_device_description", new_iot_device_description);


          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              if (this.responseText == "done") {                          
                // set the figures visible
                //document.getElementById("visualize-data").style.visibility = "visible";
                alert("IoT device added");
                // clear the content of the fields
                document.getElementById("new-iot-device-name").value = "";
                document.getElementById("new-iot-device-description").value = "";
              } else {
                alert("Error occured while adding!");
              }
            }
          };

          // send the AJAX request
          xhttp.open("POST", "/add-iot-device", true);
          xhttp.send(formData);
        }

          // things to do once the document is loaded
          $(document).ready( function() {          
            // set the dataset selection menu
            //setDatasetSelectionList();

            // set the IoT devices selection menu
            setIoTDeviceSelectionList();

            // set the modules as checkbox elements
            //setModulesCheckboxList();

        } );

        function setIoTDeviceSelectionList() {
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {

              // take the received JSON object
              var response = JSON.parse(this.response);
              
              // take the number of IoT devices
              var len = parseInt(response["length"]);

              // process each IoT device
              for (var i=1; i<=len; i++) {          
                // add the option to the select menu
                $('#select-iot-device-to-delete').append($('<option>', {
                  value: response[i.toString()]["value"],
                  text: response[i.toString()]["text"]
                }));
              }
              
              // refresh the select menu to make the newly added options visible
              $( "#iot-device-type" ).selectmenu("refresh", true);
            }
          };
          // send the AJAX request
          xhttp.open("POST", "/get_iot_device_list", true);
          xhttp.send();
        }

      </script>

    <title>EMvidence Side-Channel Investigator</title>
    </head>
  
    <body>
    
    <!-- the main toolbar-->
    {% include 'main-toolbar.html' %}


    <div class="emvidence-settings">
      <form action="/" method="POST">
        <fieldset>
        <legend>General Settings</legend>
        <table>
          <tr>
            <td>Default directory to save EM data:<input type="text" name="default-capture-directory" id="default-capture-directory"></td>
          </tr>
          <tr>
            <td>
              <label>Default EM data file format:</label>              
              <select name="em-data-format" id="em-data-format">
                <option value="npy">NumPy format</option>
                <option value="cfile">cFile format</option>
              </select>
            </td>
          </tr>          
        </table>

        <table>
          <tr>
            <td><div class="save-button"><button>Save</button></div></td>
            <td><div class="cancel-button"><button>Cancel</button></div></td>
          </tr>
        </table>

        </fieldset>
      </form>
    </div>

    <form action="/add-module" method="post" enctype="multipart/form-data">
      <fieldset>
        <legend>Module Settings</legend>
        <table>
          <tr>
            <td>
            Select module ZIP file to upload:
            <div class="widget">
              <input type="file" name="fileToUpload" id="fileToUpload">
              <input type="submit" value="Upload ZIP" name="submit">
              <input type="button" value="Cancel" name="cancel-upload" id="cancel-upload">
            </div>
            </td>
          </tr>

          <tr>
            <td>
              <label>Select a module to delete:</label>
              <select id = "select-module-to-delete">
                <option disabled selected>Please pick a module</option>
                <option value = "module-id-1">Arduino Activity Detection</option>
                <option value = "module-id-2">Arduino Modification Detection</option>
                <option value = "module-id-3">Raspberry Pi Cryptography Detection</option>
                <option value = "module-id-4">Another Module</option>
              </select>
            </td>
            <td>
              <div class="module-delete-widget">
                <input type="button" value="Delete" name="delete-module" id="delete-module">
                <input type="button" value="Cancel" name="cancel-delete" id="cancel-delete">
              </div>
            </td>
          </tr>
      </table>
      </fieldset>
    </form>

    <form action="/" method="POST">
      <fieldset>
      <legend>IoT Device Settings</legend>
      <table>
        <tr>
          <td>IoT device name:<input type="text" name="new-iot-device-name" id="new-iot-device-name"></td>  
        </tr>
        <tr>
          <td>IoT device description:</td>
        </tr>
        <tr>
          <td>
            <textarea name="new-iot-device-description" id="new-iot-device-description" rows="4" cols="50" placeholder="Add device description" wrap="physical"></textarea>
          </td>
        </tr>
      </table> 

      <table>
        <tr>
          <td><div class="save-iot-button"><button>Add IoT device</button></div></td>
          <td><div class="cancel-iot-button"><button>Cancel IoT device</button></div></td>
        </tr>
      </table>
       
      <table>
        <tr>
          <td>
            <label>Select an IoT device to delete:</label>
            <select id = "select-iot-device-to-delete">
              <option value="select-device" selected="true" disabled="disabled">Please pick an IoT device</option>              
            </select>
          </td>
          <td>
            <div class="module-delete-widget">
              <input type="button" value="Delete" name="delete-iot-device" id="delete-iot-device">
              <input type="button" value="Cancel" name="cancel-iot-delete" id="cancel-iot-delete">
            </div>
          </td>
        </tr>
      </table>

      </fieldset>
    </form>



    <div id="footer">
    <br/>
    <hr width="100%">
    EMvidence Side-Channel Investigator
    </div>

    </body>
</html>